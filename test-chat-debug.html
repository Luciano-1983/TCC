<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Chat Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .chat-section { border: 1px solid #ccc; margin: 10px; padding: 10px; }
        .hidden { display: none; }
        .message { margin: 5px; padding: 5px; border-radius: 5px; }
        .received { background-color: #e3f2fd; }
        .sent { background-color: #e8f5e8; }
        button { margin: 5px; padding: 10px; }
        #logs { background-color: #f5f5f5; padding: 10px; margin: 10px; height: 200px; overflow-y: scroll; }
    </style>
</head>
<body>
    <h1>Teste Chat Debug</h1>
    
    <div>
        <button onclick="simularLoginProfissional()">Simular Login Profissional</button>
        <button onclick="simularLoginUsuario()">Simular Login Usuário</button>
        <button onclick="simularMensagemUsuario()">Simular Mensagem de Usuário</button>
        <button onclick="simularMensagemProfissional()">Simular Mensagem de Profissional</button>
    </div>
    
    <div class="chat-section" id="user-chat-section">
        <h3>Chat do Usuário</h3>
        <div id="user-chat-messages"></div>
        <input type="text" id="user-message-input" placeholder="Mensagem do usuário">
        <button onclick="enviarMensagemUsuario()">Enviar</button>
    </div>
    
    <div class="chat-section" id="professional-chat-section" class="hidden">
        <h3>Chat do Profissional</h3>
        <div id="professional-chat-messages"></div>
        <input type="text" id="professional-message-input" placeholder="Mensagem do profissional">
        <button onclick="enviarMensagemProfissional()">Enviar</button>
    </div>
    
    <div id="logs">
        <h4>Logs:</h4>
        <div id="log-content"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let profissionalLogado = null;
        let usuarioLogado = null;
        
        function log(message) {
            const logContent = document.getElementById('log-content');
            const timestamp = new Date().toLocaleTimeString();
            logContent.innerHTML += `[${timestamp}] ${message}<br>`;
            logContent.scrollTop = logContent.scrollHeight;
            console.log(message);
        }
        
        function simularLoginProfissional() {
            profissionalLogado = { id: 1, nome: 'Dr. Silva' };
            usuarioLogado = null;
            document.getElementById('professional-chat-section').classList.remove('hidden');
            document.getElementById('user-chat-section').classList.add('hidden');
            socket.emit('login', { userId: 1, type: 'professional' });
            log('Profissional logado: ' + JSON.stringify(profissionalLogado));
        }
        
        function simularLoginUsuario() {
            usuarioLogado = { id: 2, nome: 'João' };
            profissionalLogado = null;
            document.getElementById('user-chat-section').classList.remove('hidden');
            document.getElementById('professional-chat-section').classList.add('hidden');
            socket.emit('login', { userId: 2, type: 'user' });
            log('Usuário logado: ' + JSON.stringify(usuarioLogado));
        }
        
        function simularMensagemUsuario() {
            socket.emit('send_message', {
                fromUserId: 2,
                toProfessionalId: 1,
                message: 'Olá, preciso de ajuda!',
                fromUserName: 'João'
            });
            log('Mensagem de usuário enviada');
        }
        
        function simularMensagemProfissional() {
            socket.emit('send_professional_message', {
                fromProfessionalId: 1,
                toUserId: 2,
                message: 'Olá! Como posso ajudar?',
                fromProfessionalName: 'Dr. Silva'
            });
            log('Mensagem de profissional enviada');
        }
        
        function enviarMensagemUsuario() {
            const input = document.getElementById('user-message-input');
            const message = input.value;
            if (message.trim()) {
                simularMensagemUsuario();
                input.value = '';
            }
        }
        
        function enviarMensagemProfissional() {
            const input = document.getElementById('professional-message-input');
            const message = input.value;
            if (message.trim()) {
                simularMensagemProfissional();
                input.value = '';
            }
        }
        
        function exibirMensagemNoChat(message, type, chatType = 'user') {
            log(`exibirMensagemNoChat: ${message} (${type}) para ${chatType}`);
            
            const messageContainer = chatType === 'user' 
                ? document.getElementById('user-chat-messages')
                : document.getElementById('professional-chat-messages');
            
            if (!messageContainer) {
                log('ERRO: Container de mensagens não encontrado para ' + chatType);
                return;
            }
            
            const newMessage = document.createElement('div');
            newMessage.classList.add('message', type);
            newMessage.textContent = message;
            messageContainer.appendChild(newMessage);
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }
        
        socket.on('receive_message', (data) => {
            log('Mensagem recebida: ' + JSON.stringify(data));
            log('profissionalLogado: ' + JSON.stringify(profissionalLogado));
            log('usuarioLogado: ' + JSON.stringify(usuarioLogado));
            
            const { fromUserId, fromProfessionalId, fromUserName, fromProfessionalName, message, type } = data;
            
            if (type === 'user' && profissionalLogado) {
                log('Profissional recebeu mensagem do usuário');
                exibirMensagemNoChat(`${fromUserName}: ${message}`, 'received', 'professional');
            } else if (type === 'professional' && usuarioLogado) {
                log('Usuário recebeu mensagem do profissional');
                exibirMensagemNoChat(`${fromProfessionalName}: ${message}`, 'received', 'user');
            } else {
                log('Mensagem não foi processada - condições não atendidas');
            }
        });
        
        socket.on('connect', () => {
            log('Conectado ao servidor Socket.IO');
        });
        
        socket.on('disconnect', () => {
            log('Desconectado do servidor Socket.IO');
        });
        
        log('Página carregada. Clique nos botões para testar o chat.');
    </script>
</body>
</html> 